name: CI

on:
  push:
    branches: [ main, benchmarking ]
  pull_request:
    branches: [ main ]

env:
  MIX_ENV: test

jobs:
  test:
    name: Test (Elixir 1.17.3 / OTP 27.3.4.2)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Elixir
      uses: erlef/setup-beam@v1
      with:
        elixir-version: '1.17.3'
        otp-version: '27.3.4.2'

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          deps
          _build
        key: ${{ runner.os }}-mix-1.17.3-27.3.4.2-${{ hashFiles('**/mix.lock') }}
        restore-keys: |
          ${{ runner.os }}-mix-1.17.3-27.3.4.2-
          ${{ runner.os }}-mix-

    - name: Install dependencies
      run: mix deps.get

    - name: Compile code
      run: mix compile --warnings-as-errors

    - name: Check code formatting
      run: mix format --check-formatted

    - name: Run Credo (static analysis)
      run: mix credo --strict
      continue-on-error: true

    - name: Run unit and integration tests
      run: mix test --exclude performance --exclude benchmark --exclude stress --exclude recovery

    - name: Generate test coverage
      run: mix test --cover --exclude performance --exclude benchmark --exclude stress --exclude recovery

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./cover/excoveralls.json
        flags: unittests
        name: codecov-umbrella
      continue-on-error: true


  recovery:
    name: Recovery & Resilience Tests  
    runs-on: ubuntu-latest
    needs: test
    continue-on-error: true  # Allow this job to fail without failing the whole pipeline

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Elixir
      uses: erlef/setup-beam@v1
      with:
        elixir-version: '1.17.3'
        otp-version: '27.3.4.2'

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          deps
          _build
        key: ${{ runner.os }}-mix-recovery-${{ hashFiles('**/mix.lock') }}
        restore-keys: |
          ${{ runner.os }}-mix-recovery-
          ${{ runner.os }}-mix-

    - name: Install dependencies
      run: mix deps.get

    - name: Compile for recovery tests
      run: MIX_ENV=test mix compile

    - name: Run crash recovery tests
      run: |
        echo "üõ†Ô∏è Running Recovery Tests (CI-friendly mode)"
        echo "Note: Some recovery tests may fail in CI due to timing constraints"
        # Run recovery tests but don't fail the build if they have issues
        mix test --include recovery --exclude performance --exclude stress --seed 0 || echo "Recovery tests completed with some failures (expected in CI)"

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Elixir
      uses: erlef/setup-beam@v1
      with:
        elixir-version: '1.17.3'
        otp-version: '27.3.4.2'

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          deps
          _build
        key: ${{ runner.os }}-mix-security-${{ hashFiles('**/mix.lock') }}
        restore-keys: |
          ${{ runner.os }}-mix-security-
          ${{ runner.os }}-mix-

    - name: Install dependencies
      run: mix deps.get

    - name: Security audit
      run: mix deps.audit
      continue-on-error: true

    - name: Check for unused dependencies
      run: mix deps.unlock --check-unused
      continue-on-error: true

  documentation:
    name: Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Elixir
      uses: erlef/setup-beam@v1
      with:
        elixir-version: '1.17.3'
        otp-version: '27.3.4.2'

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          deps
          _build
        key: ${{ runner.os }}-mix-docs-${{ hashFiles('**/mix.lock') }}
        restore-keys: |
          ${{ runner.os }}-mix-docs-
          ${{ runner.os }}-mix-

    - name: Install dependencies
      run: mix deps.get

    - name: Check documentation coverage
      run: mix docs --output doc
      continue-on-error: true

    - name: Upload documentation
      if: github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: doc/
      continue-on-error: true